
#--------------------------------------------------------------------------------
# Workflow configuration
#--------------------------------------------------------------------------------

name: Build MT5 Monte Carlo
on:
  push:
    tags:
      - "v*" 

permissions:
  contents: write

#--------------------------------------------------------------------------------
# Define application name & version
#--------------------------------------------------------------------------------

env:
  VERSION: "0.1.0"
  EXECUTABLE: "appMT5MonteCarlo"
  APPLICATION: "MT5 Monte Carlo"
  QML_DIR: "."
  QT_VERSION: "6.9.3"

#--------------------------------------------------------------------------------
# Workflow jobs
#--------------------------------------------------------------------------------

jobs:
  #
  # Linux AppImage build
  #
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      #
      # Checkout the repository
      #
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      #
      # Install Qt 6.9.3 with aqtinstall
      #
      - name: Install Qt ${{env.QT_VERSION}}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install aqtinstall

          # Install Qt with architecture specified and modules
          python3 -m aqt install-qt linux desktop ${{env.QT_VERSION}} linux_gcc_64 \
            --outputdir ${{github.workspace}}/Qt \
            -m qtgraphs qtquick3d qtshadertools

          echo "Qt6_DIR=${{github.workspace}}/Qt/${{env.QT_VERSION}}/linux_gcc_64/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "${{github.workspace}}/Qt/${{env.QT_VERSION}}/linux_gcc_64/bin" >> $GITHUB_PATH

      #
      # Install build dependencies
      #
      - name: Install dependencies
        run: |
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libgl1-mesa-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libzstd-dev \
            libxcb-cursor0 \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libx11-xcb-dev \
            libxext-dev \
            libxfixes-dev \
            libxi-dev \
            libxrender-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxcb-glx0-dev \
            libxcb-keysyms1-dev \
            libxcb-image0-dev \
            libxcb-shm0-dev \
            libxcb-icccm4-dev \
            libxcb-sync-dev \
            libxcb-xfixes0-dev \
            libxcb-shape0-dev \
            libxcb-randr0-dev \
            libxcb-render-util0-dev \
            libxcb-util-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            file \
            wget

      #
      # Build and install xlnt from source
      #
      - name: Build xlnt
        run: |
          git clone https://github.com/tfussell/xlnt.git
          cd xlnt
          git submodule update --init --recursive
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      #
      # Configure and build the application
      #
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr
        env:
          Qt6_DIR: ${{github.workspace}}/Qt/${{env.QT_VERSION}}/gcc_64/lib/cmake/Qt6

      - name: Build
        run: |
          cd build
          cmake --build . --parallel $(nproc)

      #
      # Install to AppDir
      #
      - name: Install to AppDir
        run: |
          cd build
          DESTDIR=appdir cmake --install .

      #
      # Create AppImage
      #
      - name: Create AppImage
        run: |
          cd build

          # Download linuxdeploy and Qt plugin
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"
          chmod +x linuxdeploy*.AppImage

          # Create desktop file
          mkdir -p appdir/usr/share/applications
          cat > appdir/usr/share/applications/${{env.EXECUTABLE}}.desktop << 'DESKTOPEOF'
          [Desktop Entry]
          Type=Application
          Name=${{env.APPLICATION}}
          Exec=${{env.EXECUTABLE}}
          Icon=${{env.EXECUTABLE}}
          Categories=Utility;
          Terminal=false
          DESKTOPEOF

          # Copy application icon
          mkdir -p appdir/usr/share/icons/hicolor/256x256/apps
          cp ../mt5_monte_carlo_icon.png appdir/usr/share/icons/hicolor/256x256/apps/${{env.EXECUTABLE}}.png

          # Set environment variables for linuxdeploy
          export QML_SOURCES_PATHS=../${{env.QML_DIR}}
          export QMAKE=${{github.workspace}}/Qt/${{env.QT_VERSION}}/linux_gcc_64/bin/qmake
          export LD_LIBRARY_PATH=${{github.workspace}}/Qt/${{env.QT_VERSION}}/gcc_64/lib:$LD_LIBRARY_PATH

          # Create AppImage
          QMAKE="${{github.workspace}}/Qt/${{env.QT_VERSION}}/gcc_64/bin/qmake" \
          ./linuxdeploy-x86_64.AppImage \
            --appdir appdir \
            --plugin qt \
            --output appimage

      # Create GitHub Release and attach AppImage    
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/MT5_Monte_Carlo-*.AppImage
          draft: false
          prerelease: false
          body: |
            # MT5 Monte Carlo v${{ env.VERSION }}
            
            Linux AppImage build for x86_64.
            
            ## Installation
            ```bash
                  chmod +x MT5_Monte_Carlo-*.AppImage
                  ./MT5_Monte_Carlo-*.AppImage
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #
  # macOS DMG build
  #
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Qt ${{ env.QT_VERSION }} (Universal clang_64 â†’ native arm64 on Apple Silicon)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          modules: qtgraphs qtquick3d qtshadertools
      - name: Install xlnt via vcpkg (ARM64)
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          ./bootstrap-vcpkg.sh
          ./vcpkg install xlnt:arm64-osx
          echo "VCPKG_ROOT=${GITHUB_WORKSPACE}/vcpkg" >> $GITHUB_ENV
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_TOOLCHAIN_FILE="${GITHUB_WORKSPACE}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=arm64-osx
      - name: Build
        run: |
          cd build
          cmake --build . --config Release --parallel
      - name: Deploy Qt dependencies
        run: |
          cd build
          macdeployqt "${{ env.EXECUTABLE }}.app" -qmldir=../ -verbose=1
      - name: Create DMG
        run: |
          cd build
          hdiutil create \
            -volname "${{ env.APPLICATION }}" \
            -srcfolder "${{ env.EXECUTABLE }}.app" \
            -ov \
            -format UDZO \
            "../MT5_Monte_Carlo-${{ env.VERSION }}-macOS.dmg"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: MT5_Monte_Carlo-*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #
  # Windows ZIP build
  #
  build-windows:
    runs-on: windows-latest
    steps:
      #
      # Checkout the repository
      #
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
      #
      # Install Qt
      #
      - name: Install Qt ${{env.QT_VERSION}}
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{env.QT_VERSION}}
          host: windows
          target: desktop
          arch: win64_msvc2022_64
          modules: 'qtgraphs qtquick3d qtshadertools'
      #
      # Setup MSVC compiler
      #
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      #
      # Install vcpkg and xlnt
      #
      - name: Install xlnt via vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install xlnt:x64-windows
          echo "VCPKG_ROOT=${{github.workspace}}\vcpkg" >> $env:GITHUB_ENV
      #
      # Configure and build
      #
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="${{github.workspace}}\vcpkg\scripts\buildsystems\vcpkg.cmake"
      - name: Build
        run: |
          cd build
          cmake --build . --config Release --parallel
      #
      # Deploy Qt dependencies with windeployqt
      #
      - name: Deploy Qt dependencies
        run: |
          cd build\Release
          windeployqt.exe --qmldir ..\..\. ${{env.EXECUTABLE}}.exe
      #
      # Copy xlnt DLL
      #
      - name: Copy xlnt DLL
        run: |
          copy vcpkg\installed\x64-windows\bin\xlnt.dll build\Release\
      #
      # Create portable ZIP
      #
      - name: Create portable ZIP
        run: |
          cd build\Release
          7z a ..\..\MT5_Monte_Carlo-${{env.VERSION}}-Windows-x64.zip *
      #
      # Create GitHub Release
      #
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: MT5_Monte_Carlo-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}